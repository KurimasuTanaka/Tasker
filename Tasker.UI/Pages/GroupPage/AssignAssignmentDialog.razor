@inject IGroupsManager _groupsManager

<MudDialog>
    <TitleContent>
        Create new task
    </TitleContent>
    <DialogContent>
        <MudTable T="Domain.User" Items="@(group.UserParticipations.Select(up => up.User))"
            OnRowClick="AddToSelection">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Assign</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.FirstName @context.LastName</MudTd>
            </RowTemplate>
        </MudTable>
    </DialogContent>
    <DialogActions>
        <MudText>To task assigned: </MudText>
        <MudText>
            @foreach (User user in usersToAssign)
            {
                @user.FirstName@user.LastName
            }
        </MudText>
        <MudButton Color="Color.Primary" OnClick="AssignAssignment">Assign to task</MudButton>
    </DialogActions>
</MudDialog>
@code {
    [Parameter] public Domain.Assignment assignment { get; set; } = new();
    [Parameter] public Domain.Group group { get; set; } = new();
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;

    List<User> usersToAssign = new();

    protected override void OnParametersSet()
    {
        usersToAssign = assignment.UserAssignments.Select(p => p.User).ToList();
    }

    private void AssignAssignment()
    {
        foreach (User user in usersToAssign)
        {
            _groupsManager.AssignTask(group.GroupId, assignment.AssignmentId, user.UserIdentity);
        }

        MudDialog.Close(DialogResult.Ok(true));
    }

    private void AddToSelection(TableRowClickEventArgs<User> args)
    {
        if (usersToAssign.Select(uta => uta.UserIdentity).Contains(args.Item!.UserIdentity))
        {
            usersToAssign.RemoveAll((u) => u.UserIdentity == args.Item.UserIdentity);
        }
        else
        {
            usersToAssign.Add(args.Item);
        }
    }
}
