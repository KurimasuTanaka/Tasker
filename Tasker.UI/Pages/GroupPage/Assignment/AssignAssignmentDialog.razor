@inject IAssignmentServiceUI _assignmentServiceUI;

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Assign users to task</MudText>
    </TitleContent>
    <DialogContent>
        <MudTable T="Domain.User" Items="usersList" SelectedItems="assignedUsers" MultiSelection="true" class="mv-3">

            <HeaderContent>
                <MudTh>Assigned Users</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.FirstName @context.LastName</MudTd>
            </RowTemplate>
        </MudTable>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="AssignAssignment">Update assignment</MudButton>
    </DialogActions>
</MudDialog>
@code {
    [Parameter] public Domain.Assignment assignment { get; set; } = new();
    [Parameter] public Domain.Group group { get; set; } = new();
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public EventCallback<Domain.Assignment> UpdateGroupCallback { get; set; }

    List<User> usersList = new();
    HashSet<User> assignedUsers = new();
    List<User> assignedUsersAtStart = new();


    protected override void OnParametersSet()
    {
        usersList = group.UserParticipations
        .Select(up => up.User)
        .Where(u => u is not null)
        .Select(u => u!)
        .ToList();

        assignedUsersAtStart = assignment.UserAssignments.
        Select(ua => ua.User).
        Where(u => u is not null).Select(u => u!).
        ToList();

        foreach (User user in assignedUsersAtStart)
        {
            try
            {
                assignedUsers.Add(usersList.First(u => u.UserIdentity == user.UserIdentity));
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }
    }

    private async Task AssignAssignment()
    {
        Domain.Assignment? updatedAssignment = assignment;
        foreach (User user in assignedUsersAtStart.Except(assignedUsers, new UserComparison()))
        {
            try
            {
                updatedAssignment = await _assignmentServiceUI.UnassignTask(group.GroupId, assignment.AssignmentId, user.UserIdentity);
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }

        foreach (User user in assignedUsers.Except(assignedUsersAtStart, new UserComparison()))
        {
            try
            {
                updatedAssignment = await _assignmentServiceUI.AssignTask(group.GroupId, assignment.AssignmentId, user.UserIdentity);
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }

        await UpdateGroupCallback.InvokeAsync(updatedAssignment);
        MudDialog.Close(DialogResult.Ok(true));
    }


}